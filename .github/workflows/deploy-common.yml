name: Deploy to EC2 (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Deployment environment (dev or prod)'
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      EC2_USER:
        required: true
      EC2_HOST:
        required: true
      SLACK_WEBHOOK_URL:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: ‚úÖ Ï≤¥ÌÅ¨ÏïÑÏõÉ
        uses: actions/checkout@v4

      - name: üì¢ Slack Î∞∞Ìè¨ ÏãúÏûë ÏïåÎ¶º
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#2196F3\",
                \"title\": \"üöÄ ${{ inputs.environment }} Î∞∞Ìè¨ ÏãúÏûë\",
                \"fields\": [
                  {\"title\": \"Ïª§Î∞ã\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true},
                  {\"title\": \"Î©îÏãúÏßÄ\", \"value\": \"${COMMIT_MSG}\", \"short\": true}
                ],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"

      - name: ‚òï Java 24 ÏÑ§Ï†ï
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: üîÅ Gradle Ï∫êÏãú
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: üß± ÎπåÎìú
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: üöÄ Î∞∞Ìè¨ (${{ inputs.environment }})
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          # SSH ÌÇ§ ÏÑ§Ï†ï (Î≥¥Ïïà Í∞ïÌôî)
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          # JAR ÌååÏùº Î∞è Î∞∞Ìè¨ Ïä§ÌÅ¨Î¶ΩÌä∏ Ï†ÑÏÜ°
          scp build/libs/*.jar $EC2_USER@$EC2_HOST:/home/ubuntu/app-new.jar
          scp scripts/deploy.sh $EC2_USER@$EC2_HOST:/home/ubuntu/deploy.sh

          # Î∞∞Ìè¨ Ïã§Ìñâ
          ssh $EC2_USER@$EC2_HOST "bash /home/ubuntu/deploy.sh"

          # SSH ÌÇ§ Ï†ïÎ¶¨ (Î≥¥Ïïà)
          rm -f ~/.ssh/id_rsa

      - name: ‚úÖ Slack Î∞∞Ìè¨ ÏÑ±Í≥µ ÏïåÎ¶º
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#4CAF50\",
                \"title\": \"‚úÖ ${{ inputs.environment }} Î∞∞Ìè¨ ÏÑ±Í≥µ\",
                \"fields\": [
                  {\"title\": \"Ïª§Î∞ã\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true}
                ],
                \"actions\": [{
                  \"type\": \"button\",
                  \"text\": \"Î°úÍ∑∏ Î≥¥Í∏∞\",
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"

      - name: ‚ùå Slack Î∞∞Ìè¨ Ïã§Ìå® ÏïåÎ¶º
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#F44336\",
                \"title\": \"‚ùå ${{ inputs.environment }} Î∞∞Ìè¨ Ïã§Ìå®\",
                \"fields\": [
                  {\"title\": \"Ïª§Î∞ã\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true}
                ],
                \"actions\": [{
                  \"type\": \"button\",
                  \"text\": \"Ïã§Ìå® Î°úÍ∑∏ Î≥¥Í∏∞\",
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"
