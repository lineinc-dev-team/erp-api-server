name: Deploy to EC2 (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Deployment environment (dev or prod)'
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      EC2_USER:
        required: true
      EC2_HOST:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: âœ… ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: â˜• Java 24 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: ğŸ” Gradle ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: ğŸ§± ë¹Œë“œ
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: ğŸš€ ë°°í¬ (${{ inputs.environment }})
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          # SSH í‚¤ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          # JAR íŒŒì¼ ë° ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
          scp build/libs/*.jar $EC2_USER@$EC2_HOST:/home/ubuntu/app-new.jar
          scp scripts/deploy.sh $EC2_USER@$EC2_HOST:/home/ubuntu/deploy.sh

          # ë°°í¬ ì‹¤í–‰
          ssh $EC2_USER@$EC2_HOST "bash /home/ubuntu/deploy.sh"

          # SSH í‚¤ ì •ë¦¬ (ë³´ì•ˆ)
          rm -f ~/.ssh/id_rsa
