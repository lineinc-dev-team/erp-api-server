name: Deploy to EC2 (Reusable)

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Deployment environment (dev or prod)'
    secrets:
      SSH_PRIVATE_KEY:
        required: true
      EC2_USER:
        required: true
      EC2_HOST:
        required: true
      SLACK_WEBHOOK_URL:
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: âœ… ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ“¢ Slack ë°°í¬ ì‹œì‘ ì•Œë¦¼
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#2196F3\",
                \"title\": \"ğŸš€ ë°°í¬ ì‹œì‘\",
                \"fields\": [
                  {\"title\": \"í™˜ê²½\", \"value\": \"\`${{ inputs.environment }}\`\", \"short\": true},
                  {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"short\": true},
                  {\"title\": \"ì»¤ë°‹\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true},
                  {\"title\": \"ë°°í¬ì\", \"value\": \"${COMMIT_AUTHOR}\", \"short\": true},
                  {\"title\": \"ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG}\", \"short\": false}
                ],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"

      - name: â˜• Java 24 ì„¤ì •
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 24

      - name: ğŸ” Gradle ìºì‹œ
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: ${{ runner.os }}-gradle-

      - name: ğŸ§± ë¹Œë“œ
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: ğŸš€ ë°°í¬ (${{ inputs.environment }})
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          # SSH í‚¤ ì„¤ì • (ë³´ì•ˆ ê°•í™”)
          mkdir -p ~/.ssh
          echo "$SSH_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $EC2_HOST >> ~/.ssh/known_hosts

          # JAR íŒŒì¼ ë° ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡
          scp build/libs/*.jar $EC2_USER@$EC2_HOST:/home/ubuntu/app-new.jar
          scp scripts/deploy.sh $EC2_USER@$EC2_HOST:/home/ubuntu/deploy.sh

          # ë°°í¬ ì‹¤í–‰
          ssh $EC2_USER@$EC2_HOST "bash /home/ubuntu/deploy.sh"

          # SSH í‚¤ ì •ë¦¬ (ë³´ì•ˆ)
          rm -f ~/.ssh/id_rsa

      - name: âœ… Slack ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#4CAF50\",
                \"title\": \"âœ… ë°°í¬ ì„±ê³µ\",
                \"text\": \"*${{ inputs.environment }}* ì„œë²„ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!\",
                \"fields\": [
                  {\"title\": \"í™˜ê²½\", \"value\": \"\`${{ inputs.environment }}\`\", \"short\": true},
                  {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"short\": true},
                  {\"title\": \"ì»¤ë°‹\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true},
                  {\"title\": \"ë°°í¬ì\", \"value\": \"${COMMIT_AUTHOR}\", \"short\": true},
                  {\"title\": \"ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG}\", \"short\": false}
                ],
                \"actions\": [{
                  \"type\": \"button\",
                  \"text\": \"ë°°í¬ ë¡œê·¸ ë³´ê¸°\",
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"

      - name: âŒ Slack ë°°í¬ ì‹¤íŒ¨ ì•Œë¦¼
        if: failure()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK" ]; then
            echo "Slack webhook not set, skipping."
            exit 0
          fi

          COMMIT_MSG=$(git log -1 --pretty=%B | head -n 1)
          COMMIT_AUTHOR=$(git log -1 --pretty=%an)
          COMMIT_HASH=$(git log -1 --pretty=%h)

          curl -X POST $SLACK_WEBHOOK \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"#F44336\",
                \"title\": \"âŒ ë°°í¬ ì‹¤íŒ¨\",
                \"text\": \"*${{ inputs.environment }}* ì„œë²„ ë°°í¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¡œê·¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.\",
                \"fields\": [
                  {\"title\": \"í™˜ê²½\", \"value\": \"\`${{ inputs.environment }}\`\", \"short\": true},
                  {\"title\": \"ë¸Œëœì¹˜\", \"value\": \"\`${{ github.ref_name }}\`\", \"short\": true},
                  {\"title\": \"ì»¤ë°‹\", \"value\": \"\`${COMMIT_HASH}\`\", \"short\": true},
                  {\"title\": \"ë°°í¬ì\", \"value\": \"${COMMIT_AUTHOR}\", \"short\": true},
                  {\"title\": \"ë©”ì‹œì§€\", \"value\": \"${COMMIT_MSG}\", \"short\": false}
                ],
                \"actions\": [{
                  \"type\": \"button\",
                  \"text\": \"ë°°í¬ ë¡œê·¸ ë³´ê¸°\",
                  \"url\": \"${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
                }],
                \"footer\": \"ERP API Server\",
                \"ts\": $(date +%s)
              }]
            }"
