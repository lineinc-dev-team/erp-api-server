name: Deploy Dev to EC2

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ” Gradle ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts', '**/gradle-wrapper.properties', '**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§± Gradleë¡œ JAR ë¹Œë“œ
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: ğŸ” SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¦ JAR íŒŒì¼ EC2ë¡œ ì „ì†¡
        run: rsync -avz --progress build/libs/*.jar ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }}:/home/ubuntu/app-new.jar

      - name: ğŸš€ EC2 ë¬´ì¤‘ë‹¨ ë°°í¬
        run: |
          ssh ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }} bash -s << 'EOF'
            set -euo pipefail

            echo "ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘"
            
            # ë³€ìˆ˜ ì„¤ì •
            APP_NEW_JAR="/home/ubuntu/app-new.jar"
            APP_LATEST_JAR="/home/ubuntu/app-latest.jar"
            PORT_1=8080
            PORT_2=8081
            
            # ìƒˆ JARë¥¼ ìµœì‹  JARë¡œ êµì²´
            mv "$APP_NEW_JAR" "$APP_LATEST_JAR"
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í™•ì¸
            CURRENT_PORT=$(sudo grep -oP 'proxy_pass http://127.0.0.1:\K[0-9]+' /etc/nginx/sites-available/erp.conf | head -n 1 || echo "$PORT_1")
            
            # ìƒˆ í¬íŠ¸ ê²°ì •
            if [ "$CURRENT_PORT" = "$PORT_1" ]; then
              NEW_PORT=$PORT_2
              OLD_APP="app"
              NEW_APP="app-new"
            else
              NEW_PORT=$PORT_1
              OLD_APP="app-new"
              NEW_APP="app"
            fi
            
            echo "â–¶ í˜„ì¬ í¬íŠ¸: $CURRENT_PORT, ìƒˆ í¬íŠ¸: $NEW_PORT"
            
            # ê¸°ì¡´ app-new í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            pm2 delete "app-new" 2>/dev/null || true
            
            # ìƒˆ ì•± ì‹œì‘
            pm2 start ecosystem.config.js --only "$NEW_APP"
            
            # ì•± ì‹œì‘ ëŒ€ê¸° (ë” ê¸´ ì‹œê°„)
            echo "â–¶ ì•± ì‹œì‘ ëŒ€ê¸° (30ì´ˆ)"
            sleep 30
            
            # í¬íŠ¸ ë¦¬ìŠ¤ë‹ í™•ì¸
            echo "â–¶ í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸"
            for i in {1..20}; do
              if ss -tlnp | grep -q ":$NEW_PORT "; then
                echo "âœ… í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸ë¨"
                break
              fi
              sleep 2
            done
            
            # í—¬ìŠ¤ì²´í¬ (ë” ì—„ê²©í•˜ê²Œ)
            echo "â–¶ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
            for i in {1..15}; do
              if curl -s --max-time 5 "http://localhost:${NEW_PORT}/actuator/health" | grep -q '"status":"UP"'; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ (ì‹œë„ $i)"
                break
              fi
              if [ $i -eq 15 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                pm2 delete "$NEW_APP" 2>/dev/null || true
                exit 1
              fi
              sleep 2
            done
            
            # ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸°
            echo "â–¶ ì¶”ê°€ ì•ˆì •í™” ëŒ€ê¸° (10ì´ˆ)"
            sleep 10
            
            # Nginx í”„ë¡ì‹œ ì „í™˜
            echo "â–¶ Nginx í”„ë¡ì‹œ ì „í™˜ ì‹œì‘"
            sudo sed -i "s/proxy_pass http:\/\/127.0.0.1:[0-9]\+/proxy_pass http:\/\/127.0.0.1:${NEW_PORT}/g" /etc/nginx/sites-available/erp.conf
            sudo nginx -s reload
            echo "âœ… Nginx í”„ë¡ì‹œ ì „í™˜ ì™„ë£Œ"
            
            # ì´ì „ ì•± ì¢…ë£Œ
            pm2 delete "$OLD_APP" 2>/dev/null || true
            pm2 save --force
            
            echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ"
          EOF