name: Deploy Dev to EC2

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ” Gradle ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts', '**/gradle-wrapper.properties', '**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§± Gradleë¡œ JAR ë¹Œë“œ
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: ğŸ” SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¦ JAR íŒŒì¼ EC2ë¡œ ì „ì†¡
        run: rsync -avz --progress build/libs/*.jar ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }}:/home/ubuntu/app-new.jar

      - name: ğŸš€ EC2 ë¬´ì¤‘ë‹¨ ë°°í¬
        run: |
          ssh ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }} bash -s << 'EOF'
            set -euo pipefail

            echo "ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘"
            
            # ë³€ìˆ˜ ì„¤ì •
            APP_NEW_JAR="/home/ubuntu/app-new.jar"
            APP_LATEST_JAR="/home/ubuntu/app-latest.jar"
            PORT_1=8080
            PORT_2=8081
            
            # ìƒˆ JARë¥¼ ìµœì‹  JARë¡œ êµì²´
            mv "$APP_NEW_JAR" "$APP_LATEST_JAR"
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ í¬íŠ¸ í™•ì¸
            CURRENT_PORT=$(sudo grep -oP 'proxy_pass http://127.0.0.1:\K[0-9]+' /etc/nginx/sites-available/erp.conf | head -n 1 || echo "$PORT_1")
            
            # ìƒˆ í¬íŠ¸ ê²°ì •
            if [ "$CURRENT_PORT" = "$PORT_1" ]; then
              NEW_PORT=$PORT_2
              OLD_APP="app"
              NEW_APP="app-new"
            else
              NEW_PORT=$PORT_1
              OLD_APP="app-new"
              NEW_APP="app"
            fi
            
            echo "â–¶ í˜„ì¬ í¬íŠ¸: $CURRENT_PORT, ìƒˆ í¬íŠ¸: $NEW_PORT"
            
            # ìƒˆ ì•± ì‹œì‘ ì „ì— ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            if [ "$NEW_APP" = "app" ]; then
              # appìœ¼ë¡œ ì „í™˜í•˜ëŠ” ê²½ìš°: app-new ë¨¼ì € ì‚­ì œ
              pm2 start ecosystem.config.js --only "$NEW_APP"
            else
              # app-newë¡œ ì „í™˜í•˜ëŠ” ê²½ìš°: appì€ ê·¸ëŒ€ë¡œ ë‘ê³  app-newë§Œ ì‹œì‘
              pm2 start ecosystem.config.js --only "$NEW_APP"
            fi
            
            # ì•± ì‹œì‘ ëŒ€ê¸° (ê°„ì†Œí™”)
            echo "â–¶ ì•± ì‹œì‘ ëŒ€ê¸° (15ì´ˆ)"
            sleep 15
            
            # í¬íŠ¸ í™•ì¸ (ê°„ì†Œí™”)
            echo "â–¶ í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸"
            for i in {1..10}; do
              if ss -tlnp | grep -q ":$NEW_PORT "; then
                echo "âœ… í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸ë¨"
                break
              fi
              if [ $i -eq 10 ]; then
                echo "âŒ í¬íŠ¸ ë¦¬ìŠ¤ë‹ ì‹¤íŒ¨"
                pm2 delete "$NEW_APP" 2>/dev/null || true
                exit 1
              fi
              sleep 2
            done
            
            # í—¬ìŠ¤ì²´í¬ (ê°„ì†Œí™”)
            echo "â–¶ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
            for i in {1..8}; do
              if curl -s --max-time 8 "http://localhost:${NEW_PORT}/actuator/health" | grep -q '"status":"UP"'; then
                echo "âœ… í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                break
              fi
              if [ $i -eq 8 ]; then
                echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
                pm2 delete "$NEW_APP" 2>/dev/null || true
                exit 1
              fi
              sleep 2
            done
            
            # ìµœì¢… ì•ˆì •í™” ëŒ€ê¸° (ê°„ì†Œí™”)
            echo "â–¶ ìµœì¢… ì•ˆì •í™” ëŒ€ê¸° (5ì´ˆ)"
            sleep 5
            
            # Nginx í”„ë¡ì‹œ ì „í™˜ (ë°±ì—… í›„ ìˆ˜ì •)
            echo "â–¶ Nginx í”„ë¡ì‹œ ì „í™˜ ì‹œì‘"
            sudo cp /etc/nginx/sites-available/erp.conf /etc/nginx/sites-available/erp.conf.backup
            sudo sed -i "s/proxy_pass http:\/\/127.0.0.1:[0-9]\+/proxy_pass http:\/\/127.0.0.1:${NEW_PORT}/g" /etc/nginx/sites-available/erp.conf
            
            # Nginx ì„¤ì • í…ŒìŠ¤íŠ¸
            if ! sudo nginx -t; then
              echo "âŒ Nginx ì„¤ì • ì˜¤ë¥˜, ë°±ì—…ì—ì„œ ë³µì›"
              sudo cp /etc/nginx/sites-available/erp.conf.backup /etc/nginx/sites-available/erp.conf
              exit 1
            fi
            
            # Nginx ì¬ì‹œì‘ (reload ëŒ€ì‹ )
            sudo systemctl restart nginx
            echo "âœ… Nginx í”„ë¡ì‹œ ì „í™˜ ì™„ë£Œ"
            
            # í”„ë¡ì‹œ ì „í™˜ í›„ ì•ˆì •í™” ëŒ€ê¸° (ê°„ì†Œí™”)
            echo "â–¶ í”„ë¡ì‹œ ì „í™˜ í›„ ì•ˆì •í™” ëŒ€ê¸° (3ì´ˆ)"
            sleep 3
            
            # ìƒˆ í¬íŠ¸ë¡œ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ (ê°„ì†Œí™”)
            echo "â–¶ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
            for i in {1..6}; do
              if curl -s --max-time 6 "http://localhost/actuator/health" | grep -q '"status":"UP"'; then
                echo "âœ… ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                break
              fi
              if [ $i -eq 6 ]; then
                echo "âŒ ì™¸ë¶€ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨, ë¡¤ë°± ì‹œì‘"
                sudo cp /etc/nginx/sites-available/erp.conf.backup /etc/nginx/sites-available/erp.conf
                sudo systemctl restart nginx
                pm2 delete "$NEW_APP" 2>/dev/null || true
                exit 1
              fi
              sleep 2
            done
            
            # ì´ì „ ì•± ì¢…ë£Œ (ëª¨ë“  ê²€ì¦ ì™„ë£Œ í›„)
            echo "â–¶ ì´ì „ ì•± ì¢…ë£Œ"
            pm2 delete "$OLD_APP" 2>/dev/null || true
            pm2 save --force
            
            echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ"
          EOF