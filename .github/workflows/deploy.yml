name: Deploy Dev to EC2

on:
  push:
    branches: [ dev ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    steps:
      - name: âœ… ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ” Gradle ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            build/
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle', '**/*.gradle.kts', '**/gradle-wrapper.properties', '**/settings.gradle') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ğŸ§± Gradleë¡œ JAR ë¹Œë“œ
        run: ./gradlew bootJar --no-daemon --parallel -x test

      - name: ğŸ” SSH í‚¤ ì„¤ì •
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEV_EC2_HOST }} >> ~/.ssh/known_hosts

      - name: ğŸ“¦ JAR íŒŒì¼ EC2ë¡œ ì „ì†¡
        run: rsync -avz --progress build/libs/*.jar ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }}:/home/ubuntu/app-new.jar

      - name: ğŸ”§ JAR íŒŒì¼ ê¶Œí•œ ì„¤ì •
        run: ssh ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }} "chmod 644 /home/ubuntu/app-new.jar"

      - name: ğŸš€ EC2 ë¬´ì¤‘ë‹¨ ë°°í¬ ë° Nginx í¬íŠ¸ ìŠ¤ìœ„ì¹­
        run: |
          ssh ${{ secrets.DEV_EC2_USER }}@${{ secrets.DEV_EC2_HOST }} bash -s << 'EOF'
            set -euo pipefail

            echo "ğŸš€ ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œì‘"
            echo "=================================="
            echo "ğŸ“– ë¬´ì¤‘ë‹¨ ë°°í¬ ì›ë¦¬:"
            echo "  1. ìƒˆ ì•±ì„ ë‹¤ë¥¸ í¬íŠ¸ì—ì„œ ì‹œì‘"
            echo "  2. ìƒˆ ì•±ì´ ì •ìƒ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸"
            echo "  3. Nginx í”„ë¡ì‹œë¥¼ ìƒˆ í¬íŠ¸ë¡œ ì „í™˜"
            echo "  4. ê¸°ì¡´ ì•± ì¢…ë£Œ (ì„œë¹„ìŠ¤ ì¤‘ë‹¨ ì—†ìŒ)"
            echo "=================================="
            
            APP_NEW_JAR="/home/ubuntu/app-new.jar"
            APP_LATEST_JAR="/home/ubuntu/app-latest.jar"
            PM2_APP_NAME_NEW="app-new"
            PM2_APP_NAME_OLD="app"
            NGINX_CONF="/etc/nginx/sites-available/erp.conf"
            PORT_1=8080
            PORT_2=8081
            
            echo "ğŸ“‹ ë°°í¬ ì„¤ì •:"
            echo "  - ìƒˆ JAR: $APP_NEW_JAR"
            echo "  - ìµœì‹  JAR: $APP_LATEST_JAR"
            echo "  - í¬íŠ¸ 1: $PORT_1"
            echo "  - í¬íŠ¸ 2: $PORT_2"
            echo "  - Nginx ì„¤ì •: $NGINX_CONF"
            echo "=================================="

            # ê°„ë‹¨í•œ í—¬ìŠ¤ì²´í¬ í•¨ìˆ˜
            health_check() {
              local port=$1
              for i in {1..10}; do
                if curl -s "http://localhost:${port}/actuator/health" | grep -q '"status":"UP"'; then
                  echo "âœ… í¬íŠ¸ $port í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
                  return 0
                fi
                sleep 3
              done
              echo "âŒ í¬íŠ¸ $port í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              return 1
            }

            echo "â–¶ ìƒˆ JARë¥¼ ìµœì‹  JARë¡œ êµì²´"
            mv "$APP_NEW_JAR" "$APP_LATEST_JAR"
            
            echo "â–¶ JAR íŒŒì¼ ê¶Œí•œ ë° ì†Œìœ ì í™•ì¸"
            ls -la "$APP_LATEST_JAR"
            
            # PM2 ì„¤ì • í™•ì¸
            echo "â–¶ PM2 ì„¤ì • íŒŒì¼ í™•ì¸"
            if [ ! -f "ecosystem.config.js" ]; then
              echo "âŒ ecosystem.config.js íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ì‹¤ì„œë²„ì— íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”."
              exit 1
            fi
            echo "âœ… ecosystem.config.js íŒŒì¼ í™•ì¸ë¨"
            
            # í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì•± í™•ì¸
            echo "â–¶ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ PM2 ì•± í™•ì¸"
            pm2 list

            CURRENT_PORT=$(sudo grep -oP 'proxy_pass http://127.0.0.1:\K[0-9]+' "$NGINX_CONF" 2>/dev/null | head -n 1 | xargs || echo "$PORT_1")
            echo "â–¶ DEBUG: CURRENT_PORT='$CURRENT_PORT', PORT_1='$PORT_1', PORT_2='$PORT_2'"
            if [ "$CURRENT_PORT" = "$PORT_1" ]; then
              NEW_PORT=$PORT_2
              OLD_APP=$PM2_APP_NAME_OLD
              NEW_APP=$PM2_APP_NAME_NEW
            else
              NEW_PORT=$PORT_1
              OLD_APP=$PM2_APP_NAME_NEW
              NEW_APP=$PM2_APP_NAME_OLD
            fi

            echo "â–¶ í˜„ì¬ Nginx í”„ë¡ì‹œ í¬íŠ¸: $CURRENT_PORT, ë³€ê²½í•  í¬íŠ¸: $NEW_PORT"


            echo "â–¶ ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜($NEW_APP)ì„ í¬íŠ¸ $NEW_PORTì—ì„œ pm2ë¡œ ì‹œì‘"
            echo "â–¶ í™˜ê²½ë³€ìˆ˜ SERVER_PORT=$NEW_PORT ì„¤ì •"
            
            # NEW_PORTì— ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ì•±ì´ ìˆë‹¤ë©´ ì‚­ì œ
            echo "â–¶ í¬íŠ¸ $NEW_PORT ì‚¬ìš© ì¤‘ì¸ ê¸°ì¡´ ì•± í™•ì¸ ë° ì‚­ì œ"
            
            # ê¸°ì¡´ app-new í”„ë¡œì„¸ìŠ¤ë§Œ ì •ë¦¬ (appì€ ìœ ì§€)
            echo "â–¶ ê¸°ì¡´ app-new í”„ë¡œì„¸ìŠ¤ë§Œ ì •ë¦¬ (appì€ ìœ ì§€)"
            pm2 delete "app-new" 2>/dev/null || true
            pm2 save --force
            sleep 3
            
            # PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ í™•ì¸
            echo "â–¶ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ í›„ ìƒíƒœ:"
            pm2 list
            
            # PM2 í”„ë¡œì„¸ìŠ¤ ëª©ë¡ í™•ì¸
            echo "â–¶ PM2 í”„ë¡œì„¸ìŠ¤ ì •ë¦¬ í›„ ìƒíƒœ:"
            pm2 list
            
            # ë””ë²„ê¹…: ecosystem.config.js ë‚´ìš© í™•ì¸
            echo "â–¶ ecosystem.config.js ë‚´ìš© í™•ì¸:"
            cat ecosystem.config.js
            
            # ë””ë²„ê¹…: app-new ì„¤ì •ì—ì„œ JAR ê²½ë¡œ í™•ì¸
            echo "â–¶ app-new ì„¤ì •ì—ì„œ JAR ê²½ë¡œ í™•ì¸:"
            grep -A 5 -B 5 "app-new" ecosystem.config.js
            
            # ìƒˆ ì•± ì‹œì‘
            echo "â–¶ $NEW_APP ì‹œì‘ ì¤‘..."
            echo "â–¶ PM2 ì‹œì‘ ì „ í™˜ê²½ë³€ìˆ˜ í™•ì¸:"
            echo "  - SERVER_PORT: $NEW_PORT"
            echo "  - JAR ê²½ë¡œ: /home/ubuntu/app-latest.jar"
            
            pm2 start ecosystem.config.js --only "$NEW_APP"
            
            echo "â–¶ $NEW_APP ì‹œì‘ í›„ ì¦‰ì‹œ ë¡œê·¸ í™•ì¸"
            pm2 logs "$NEW_APP" --lines 20

            echo "â–¶ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ëŒ€ê¸° (15ì´ˆ)"
            sleep 15

            echo "â–¶ PM2 ì•± ìƒíƒœ í™•ì¸"
            pm2 list
            
            if ! pm2 list | grep -q "${NEW_APP}.*online"; then
              echo "âŒ $NEW_APP ì˜¨ë¼ì¸ ìƒíƒœ ì§„ì… ì‹¤íŒ¨"
              echo "â–¶ ìƒì„¸ ë¡œê·¸ í™•ì¸:"
              pm2 logs "$NEW_APP" --lines 100
              pm2 delete "$NEW_APP" 2>/dev/null || true
              exit 1
            fi

            echo "â–¶ í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸ (15ì´ˆ ëŒ€ê¸°)"
            sleep 15
            
            # í¬íŠ¸ í™•ì¸ (ë” ì •í™•í•œ ë§¤ì¹­)
            echo "â–¶ ë””ë²„ê¹… ì •ë³´:"
            echo "  - NEW_PORT: '$NEW_PORT'"
            echo "  - NEW_APP: '$NEW_APP'"
            echo "  - OLD_APP: '$OLD_APP'"
            
            echo "â–¶ $NEW_APP í”„ë¡œì„¸ìŠ¤ ìƒì„¸ ì •ë³´:"
            pm2 show "$NEW_APP"
            
            echo "â–¶ í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ ìƒíƒœ ìƒì„¸ í™•ì¸:"
            ss -tlnp | grep ":$NEW_PORT " || echo "í¬íŠ¸ $NEW_PORTì—ì„œ ë¦¬ìŠ¤ë‹í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            echo "â–¶ ì „ì²´ í¬íŠ¸ ìƒíƒœ:"
            ss -tlnp | grep -E ":(8080|8081) " || echo "í¬íŠ¸ 8080, 8081ì—ì„œ ë¦¬ìŠ¤ë‹í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            echo "â–¶ Java í”„ë¡œì„¸ìŠ¤ í™•ì¸:"
            ps aux | grep java | grep -v grep || echo "Java í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
            
            # í¬íŠ¸ í™•ì¸ (ë” ì•ˆì „í•œ ë°©ì‹)
            PORT_CHECK_RESULT=$(ss -tlnp | grep -c ":$NEW_PORT")
            echo "â–¶ í¬íŠ¸ $NEW_PORT í™•ì¸ ê²°ê³¼: $PORT_CHECK_RESULTê°œ í”„ë¡œì„¸ìŠ¤"
            
            if [ "$PORT_CHECK_RESULT" -eq 0 ]; then
              echo "âŒ í¬íŠ¸ $NEW_PORTì—ì„œ ë¦¬ìŠ¤ë‹í•˜ì§€ ì•ŠìŒ"
              echo "â–¶ ë³€ìˆ˜ ê°’ í™•ì¸:"
              echo "  - NEW_PORT: '$NEW_PORT'"
              echo "  - NEW_APP: '$NEW_APP'"
              echo "â–¶ í˜„ì¬ í¬íŠ¸ ìƒíƒœ:"
              ss -tlnp | grep -E ":(8080|8081) " || echo "í¬íŠ¸ 8080, 8081ì—ì„œ ë¦¬ìŠ¤ë‹í•˜ëŠ” í”„ë¡œì„¸ìŠ¤ ì—†ìŒ"
              echo "â–¶ PM2 ì•± ìƒíƒœ:"
              pm2 list
              echo "â–¶ $NEW_APP ìƒì„¸ ì •ë³´:"
              pm2 show "$NEW_APP"
              echo "â–¶ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¡œê·¸:"
              pm2 logs "$NEW_APP" --lines 100
              pm2 delete "$NEW_APP" 2>/dev/null || true
              exit 1
            fi
            echo "âœ… í¬íŠ¸ $NEW_PORT ë¦¬ìŠ¤ë‹ í™•ì¸ë¨"

            echo "â–¶ í—¬ìŠ¤ì²´í¬ ì‹œì‘"
            if ! health_check $NEW_PORT; then
              echo "âŒ í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              pm2 delete "$NEW_APP" 2>/dev/null || true
              exit 1
            fi

            echo "âœ… $NEW_APP í—¬ìŠ¤ì²´í¬ í†µê³¼, Nginx í”„ë¡ì‹œ í¬íŠ¸ ì „í™˜ ì‹œì‘"

            sudo sed -i "s/proxy_pass http:\/\/127.0.0.1:[0-9]\+/proxy_pass http:\/\/127.0.0.1:${NEW_PORT}/g" "$NGINX_CONF"
            sudo nginx -s reload
            echo "â–¶ Nginx ë¦¬ë¡œë“œ ì™„ë£Œ"
          
          
          
            echo "â–¶ ì´ì „ ì•±($OLD_APP) ì¢…ë£Œ"
            pm2 delete "$OLD_APP" 2>/dev/null || true
            
            # PM2 ì„¤ì • ì €ì¥
            echo "â–¶ PM2 ì„¤ì • ì €ì¥"
            pm2 save --force

            echo "â–¶ ìµœì¢… í—¬ìŠ¤ì²´í¬"
            if ! health_check $NEW_PORT; then
              echo "âŒ ìµœì¢… í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨"
              exit 1
            fi

            echo "âœ… ë¬´ì¤‘ë‹¨ ë°°í¬ ì™„ë£Œ"
            exit 0
          EOF